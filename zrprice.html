<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width,initial-scale=1.0" /><title></title><style>body { width: 45%; max-width: 666px; margin-left: auto; margin-right: auto } @media screen and (max-width: 960px) { body { width: 96%; margin-left: auto; margin-right: auto } } a { text-decoration: none; color: #576b95 } img { max-width: 100% }</style></head><body><h2>    自如价格分析（仅作为简历附件使用，请勿转发分享）<br/></h2><p>    自如找房首页是&nbsp;<a href="http://wh.ziroom.com/z/nl/z3.html" target="_blank">http://wh.ziroom.com/z/nl/z3.html</a>，观察网页结构，确定大致思路。</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3w1drkxfbj30yg0mf78p.jpg" class="loadingclass"/></p><p>    我们的目标数据是每间房的详情链接、楼盘名称和价格，详情链接相当于房间的 id。网页最多展示50页，所以不能直接遍历，需要细分至页面数量小于50，我们选择按区域下的商圈筛选分类，在首页 url 后面加上<em>?p=页码</em>就是对应第几页的 url。打开开发者工具，查看具体的网页结构。</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3w250v6n6j317z0ikjw9.jpg" class="loadingclass"/></p><p>    详情链接和楼盘名称可以直接获取，但价格有反爬，既不是文本也不是直接的图片。检查价格元素，发现有一张底图，通过设置不同的偏移来显示价格的每一位，打开图片 url 看一下，</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3w2d3cby1j308c00u744.jpg" class="loadingclass"/></p><p>    刷新一下页面，图片变了，</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3w2iqf51vj308c00u744.jpg" class="loadingclass"/></p><p>    也就是说图片每次都是随机生成的，无法仅仅根据偏移量来得到对应数字，此处我们的处理方法是用 OCR 识别图片上的数字再根据偏移量得到价格每一位的数字最后拼接在一起。</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3w9obvliij30e905waab.jpg"/></p>    未识别出内容或识别结果不理想，可能原因是数字太靠近图片边缘，因此尝试把图片的边缘扩大。</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3w9ttgknkj30hb07o3z3.jpg"/></p><p>    可以准确识别。价格的偏移是用 js 操作的，检查页面，定位到如下 js，</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3wa48ekk6j30xk08g758.jpg"/></p><p>    变量 ROOM_PRICE 存放了价格图片的 url 和该页面每间房的价格偏移，偏移为数组形式，可以在 Python 中遍历列表得到价格，同时也可以通过 offset 的长度得到该页面的房间展示量。当页码大于页面数量时，</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3waurt9xaj312s0h6whc.jpg"/></p><p>    会显示找不到结果，image 值为空，无 offset，因此可以通过 image 的值判断该页面是否有房间，即判断循环终点。</p><p>    以上分析表明获取目标数据是可行的，接下来开始动工，获取数据主要用到了 requests 和&nbsp;BeautifulSoup 两个库，首先用 requests 获取页面内容，再按需选择 BeautifulSoup 的搜索方法、CSS 选择器、正则等多种方式从文档树中提取信息。</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3wbseqvxij30z00hcwh3.jpg"/></p><p>    单个页面的信息已经获取了，接下来是细分范围并遍历从而获取所有的信息。先看看商圈信息，</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3wc23x29wj30iy0bnq47.jpg"/></p><p>    一共71个商圈，我们需要在商圈下设置循环，直至翻到最后一页。定义一个获取单页信息的 spider 函数，然后在循环中调用此函数。</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3wcgxjlvwj309g03mwef.jpg"/></p><p>    最后用 pandas 保存数据到数据库，用3个列表分别存放详情链接、楼盘、价格，将 spider 函数的打印内容添加到列表，用字典构建一个 DataFrame，按详情链接去重，重复的原因有两个，一是遍历过程中正好有房间状态发生变化，二是不同商圈下的确存在同一个房间，去重后写入 MySQL 数据库。</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3x93xao84j30gi046jrl.jpg"/></p><p>    结果如下，</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3x8ipryrcj30eh06774m.jpg"/></p><p>    从每个楼盘中选取一个链接用来获取二级页面中的楼盘经纬度。</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3x98mri7gj30b0069aa1.jpg"/></p><p>    检查二级页面，</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3x9ewlg00j30xx0cxtak.jpg"/></p><p>    将选取的链接存入列表，遍历获取每个楼盘的经纬度，结果保存至 MySQL 数据库。</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3xd7q680vj30i009djsc.jpg"/></p><p>    结果如下，</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3y3m4mjv9j30fp05kaa9.jpg"/></p><p>    两个表连接查询得到每个楼盘的经纬度</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3y5ipr1d9j30gk07ct8u.jpg"/></p><p>    抛开价格，查看待租房源密度，引用百度地图 API，</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3y7053ayjj30gp05b0t9.jpg"/></p><p>    结果如下，</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3y74iy56nj30c308nn1c.jpg"/></p><p>    江岸、江汉、青山、硚口、汉阳的待租房较多，其次是关山、南湖。同理制作价格热力图，结果如下，</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3y7jyf7lpj30k60e5alj.jpg"/></p><p>    高价集中在江汉、南湖、关山、徐东，选择红色区域边缘的黄色区域可能会找到性价比较高的房间。用 pandas 读取 MySQL 数据库查看价格概要，用 matplotlib 绘制直方图查看价格分布。</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3ydqim572j30i508bdga.jpg"/></p><p>    一共6026间待租房，平均价格为1110，最低价格为560，最高价格为2360。</p><p style="text-align: center"><img src="https://cdn.sinaimg.cn.52ecy.cn/large/005BYqpgly1g3ydt2tz1dj30hs0dc74c.jpg"/></p><p>    大部分房间的价格分布在950-1250，比较高，如果房间品质高、管家服务好，那么还是值得选择的。</p></body></html>